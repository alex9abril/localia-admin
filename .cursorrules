# Cursor Rules para LOCALIA Admin

## üóÑÔ∏è Reglas para Base de Datos

### IMPORTANTE: Antes de cualquier operaci√≥n de base de datos

**SIEMPRE** debes revisar los archivos SQL en la carpeta `database/` antes de:
- Crear nuevas tablas, columnas, √≠ndices o constraints
- Modificar estructuras existentes
- Crear nuevos endpoints que consulten la base de datos
- Implementar servicios que interact√∫en con la base de datos
- Crear DTOs o interfaces TypeScript basadas en esquemas de base de datos

### Archivos y scripts de referencia obligatorios a revisar en `database/`:

> **IMPORTANTE:**  
> No basta con revisar solo los archivos principales (`schema.sql`, algunos seeds o el README).  
> Es fundamental considerar que en la carpeta `database/` pueden existir m√∫ltiples archivos SQL involucrados en la evoluci√≥n y migraci√≥n del esquema, datos de ejemplo, cat√°logos, hotfixes, o migraciones espec√≠ficas que afecten la estructura real y actual de la base de datos.
>
> Siempre revisa TODOS los archivos relevantes en la carpeta `database/`, ya que las modificaciones a la estructura (tablas, columnas, √≠ndices, constraints, triggers, relaciones, etc.) pueden haberse realizado en diferentes scripts a lo largo del tiempo.

1. **`database/schema.sql`**  
   - Estructura base y principal de la base de datos  
   - Define todos los schemas, tablas, columnas, constraints y tipos principales  
   - Define √≠ndices, triggers, funciones, y relaciones

2. **Archivos de migraci√≥n, fixes, y cat√°logos** (p. ej. `business_categories_catalog.sql`, `migrations_*.sql`, `update_*_table.sql`)  
   - Contienen cambios incrementales, migraciones hist√≥ricas, o alteraciones importantes sobre el schema base  
   - Aqu√≠ pueden agregarse o modificarse columnas, constraints, relaciones o datos fundamentales  
   - **SIEMPRE** revisa si hay nuevos scripts o migraciones ejecutadas posteriormente al schema base

3. **`database/README.md`**  
   - Documentaci√≥n sobre la organizaci√≥n por schemas  
   - Listados de tablas, relaciones y ejemplos de consultas  
   - Puede se√±alar convenciones o atajos importantes

4. **Seeds y datos de ejemplo (`seed_*.sql`)**  
   - Incluyen cat√°logos iniciales y ejemplos (ej: `seed_catalog.sql`, `seed_delivery_cycle.sql`)
   - Ayudan a entender los datos t√≠picos de la base, relaciones y flujos reales  
   - √ötiles para pruebas y comprensi√≥n de uso en producci√≥n real

> **Resumen:**  
> Antes de tomar cualquier decisi√≥n que involucre la base de datos, revisa el conjunto completo de archivos SQL y documentaci√≥n presente en la carpeta `database/` para asegurarte de tener el contexto actualizado de la estructura, migraciones y datos, y evitar inconsistencias o perder rastros de cambios importantes.

### Checklist antes de implementar:

- [ ] ¬øRevis√© todos los archivos relevantes en la carpeta `database/` (incluyendo `schema.sql`, migraciones, cat√°logos y seeds) para verificar la estructura y cambios de las tablas?
- [ ] ¬øVerifiqu√© los nombres exactos de las columnas (case-sensitive)?
- [ ] ¬øConfirm√© los tipos de datos (UUID, TEXT, DECIMAL, BOOLEAN, JSONB, etc.)?
- [ ] ¬øRevis√© las relaciones (foreign keys) y constraints?
- [ ] ¬øVerifiqu√© los ENUMs disponibles para campos espec√≠ficos?
- [ ] ¬øConfirm√© si hay triggers o funciones que afecten las operaciones?
- [ ] ¬øRevis√© si hay √≠ndices que deba considerar en las consultas?
- [ ] ¬øVerifiqu√© si la tabla est√° en un schema espec√≠fico (core, catalog, orders, etc.)?

### Convenciones importantes:

1. **Schemas**: Las tablas est√°n organizadas en schemas:
   - `core.*` - Entidades principales (user_profiles, businesses, repartidores, addresses)
   - `catalog.*` - Cat√°logo (product_categories, products, collections)
   - `orders.*` - Pedidos (orders, order_items, deliveries)
   - `reviews.*` - Evaluaciones (reviews, tips)
   - `communication.*` - Comunicaci√≥n (notifications, messages)
   - `commerce.*` - Comercio (promotions, subscriptions, ads)
   - `social.*` - Red social (social_posts, social_likes, etc.)

2. **Tipos de datos**:
   - IDs: `UUID` (usar `gen_random_uuid()` o UUIDs v√°lidos)
   - Geolocalizaci√≥n: `POINT` (PostgreSQL nativo, usar `(location)[0]` y `(location)[1]` para extraer coordenadas)
   - JSON: `JSONB` para variantes, informaci√≥n nutricional, etc.
   - Arrays: `TEXT[]` para al√©rgenos, tags, etc.
   - Precios: `DECIMAL(10,2)` para montos monetarios

3. **Eliminaci√≥n l√≥gica**:
   - **NUNCA** eliminar f√≠sicamente registros
   - Usar campos `is_active`, `is_available`, o `status` para desactivar
   - Las tablas NO tienen `deleted_at` por defecto, usar campos booleanos

4. **Autenticaci√≥n**:
   - Usar `auth.users` de Supabase para autenticaci√≥n
   - `core.user_profiles` extiende `auth.users` con roles y datos adicionales
   - El `id` de `user_profiles` debe coincidir con `auth.users.id`

5. **Wallet Integration**:
   - Los campos `wallet_*` son `VARCHAR(255)`, NO `UUID`
   - El wallet es un proyecto separado, solo se almacenan referencias

### Ejemplos de consultas correctas:

```sql
-- ‚úÖ CORRECTO: Usar schema prefix
SELECT * FROM core.user_profiles WHERE role = 'client';

-- ‚úÖ CORRECTO: Extraer coordenadas de POINT
SELECT (location)[0] as longitude, (location)[1] as latitude FROM core.businesses;

-- ‚úÖ CORRECTO: Usar gen_random_uuid() para nuevos registros
INSERT INTO catalog.products (id, business_id, name, price) 
VALUES (gen_random_uuid(), $1, $2, $3);

-- ‚ùå INCORRECTO: No usar schema prefix
SELECT * FROM user_profiles; -- FALLA si la tabla est√° en schema 'core'

-- ‚ùå INCORRECTO: Intentar usar ST_X/ST_Y con POINT
SELECT ST_X(location) FROM core.businesses; -- FALLA, usar (location)[0] en su lugar
```

### Cuando trabajes con backend (NestJS):

1. **DTOs**: Basa los DTOs en la estructura real de `schema.sql`
2. **Services**: Usa los nombres exactos de columnas y schemas
3. **Queries**: Siempre incluye el schema prefix en las consultas SQL
4. **Tipos TypeScript**: Mapea correctamente los tipos PostgreSQL a TypeScript:
   - `UUID` ‚Üí `string`
   - `DECIMAL` ‚Üí `number`
   - `BOOLEAN` ‚Üí `boolean`
   - `JSONB` ‚Üí `any` o interface espec√≠fica
   - `TEXT[]` ‚Üí `string[]`
   - `POINT` ‚Üí Extraer como `{ longitude: number, latitude: number }`

### Cuando trabajes con frontend:

1. **Interfaces TypeScript**: Deben coincidir exactamente con la estructura de las tablas
2. **Formularios**: Validar tipos de datos seg√∫n los constraints del schema
3. **Filtros**: Usar los nombres exactos de columnas que existen en el schema

## üìù Notas adicionales

- Si encuentras inconsistencias entre el c√≥digo y `schema.sql`, **SIEMPRE** prioriza `schema.sql` como fuente de verdad
- Si necesitas modificar el schema, actualiza `schema.sql` primero y luego el c√≥digo
- Para nuevos campos, verifica si hay triggers o funciones que los afecten
- Para relaciones, verifica las foreign keys y constraints en `schema.sql`

